/*
 * Copyright (c) 2023, Salesforce, Inc.
 * All rights reserved.
 * SPDX-License-Identifier: Apache 2.0 Clause
 * For full license text, see the LICENSE file in the repo root or http://www.apache.org/licenses/
 */
@isTest
private class HealthCloudMenuControllerTest {
    
    private static final String EXTERNAL_STRINGS = '{ "size": 22, "totalSize": 15, "done": true, "queryLocator": null, "entityTypeName": "ExternalString", "records": [ { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x000007AblEAAS" }, "Id": "1014x000007AblEAAS", "Name": "MappingDocTitle", "Value": "Transition Approach", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x000007AblYAAS" }, "Id": "1014x000007AblYAAS", "Name": "MappingDocExtension", "Value": "Assessment Results", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x000007AbldAAC" }, "Id": "1014x000007AbldAAC", "Name": "MappingDocColumnSection", "Value": "Migration Analysis", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x000007Abl4AAC" }, "Id": "1014x000007Abl4AAC", "Name": "MappingDocColumnType", "Value": "Intro", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x000007AblTAAS" }, "Id": "1014x000007AblTAAS", "Name": "MappingDocColumnSourceObject", "Value": "Upgrade Recommendation", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAMcRAAX" }, "Id": "1014x00000FAMcRAAX", "Name": "MappingDocColumnDestObject", "Value": "What industry product would you like to transition to?", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAMcWAAX" }, "Id": "1014x00000FAMcWAAX", "Name": "MappingDocColumnSource", "Value": "How is your customer represented?", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAMcbAAH" }, "Id": "1014x00000FAMcbAAH", "Name": "MappingDocColumnDest", "Value": "Do you group together your customers through any shared relationships?", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAMcgAAH" }, "Id": "1014x00000FAMcgAAH", "Name": "MappingDocSectionAdditional", "Value": "Do these groups aggregate or summarize counts/sums of customer related products,services, or activities?", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAGK9AAP" }, "Id": "1014x00000FAGK9AAP", "Name": "MappingDocTypeField", "Value": "Here\'s a high-level view of how FSC features and customizations can be approached for possible migration . Use this information to create the first draft of your gap analysis. To get a closer look, click the link for each feature or customization for recommendations for specific changes. But remember: You\'re the Salesforce expert at your company. Leverage the usage data in each section to decide whether our recommendations are worth your effort. For example, if the report identifies AppExchange packages require a thoughtful rollout but no one is using them, cross that feature off your gap analysis.", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAGK9AAP" }, "Id": "1014x00000FAGK9AAP", "Name": "MappingDocTypeRT", "Value": "Here\'s a high-level view of how FSC features and customizations can be approached for possible migration . Use this information to create the first draft of your gap analysis. To get a closer look, click the link for each feature or customization for recommendations for specific changes. But remember: You\'re the Salesforce expert at your company. Leverage the usage data in each section to decide whether our recommendations are worth your effort. For example, if the report identifies AppExchange packages require a thoughtful rollout but no one is using them, cross that feature off your gap analysis.", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAGK9AAP" }, "Id": "1014x00000FAGK9AAP", "Name": "MappingDocColumnDataType", "Value": "Data Type", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAGK9AAP" }, "Id": "1014x00000FAGK9AAP", "Name": "MappingDocColumnDecimalPlaces", "Value": "Decimal Places", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAGK9AAP" }, "Id": "1014x00000FAGK9AAP", "Name": "MappingDocColumnConflict", "Value": "Conflict for Transition?", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAGK9AAP" }, "Id": "1014x00000FAGK9AAP", "Name": "MappingDocColumnRequired", "Value": "Required?", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAGK9AAP" }, "Id": "1014x00000FAGK9AAP", "Name": "MappingDocColumnLength", "Value": "Length", "Language": "en_US" }, { "attributes": { "type": "ExternalString", "url": "/services/data/v50.0/tooling/sobjects/ExternalString/1014x00000FAGK9AAP" }, "Id": "1014x00000FAGK9AAP", "Name": "MappingDocColumnLookupFilters", "Value": "Length", "Language": "en_US" } ] }';
    private static final String MAPPING_JSON = '{ "recommended": [ { "mappingData": [ { "destination": "Account", "fieldMapping": [], "recordTypeMapping": [ { "userGenerated": "true", "destination": "PersonAccount", "source": "" } ], "showDetails": false, "source": "" }, { "destination": "Account", "fieldMapping": [], "recordTypeMapping": [], "showDetails": false, "source": "" }, { "destination": "Contact", "fieldMapping": [], "recordTypeMapping": [], "showDetails": false, "source": "" }, { "destination": "HealthcareProvider", "fieldMapping": [], "recordTypeMapping": [], "showDetails": false, "source": "" } ], "screenId": "m0K5f000000lvvdEAA", "sectionName": "Account Types - Provider" }, { "mappingData": [ { "destination": "CareProgram", "fieldMapping": [], "recordTypeMapping": [], "showDetails": false, "source": "" } ], "screenId": "m0K5f000000lvvsEAA", "sectionName": "Care Program - Care Program" } ], "additional": [] }';
    private static final String NEW_MAPPING = '[ { "mappingData": [ { "destination": "Account", "fieldMapping": [], "recordTypeMapping": [ { "userGenerated": "true", "destination": "PersonAccount", "source": "" } ], "showDetails": false, "source": "" }, { "destination": "Account", "fieldMapping": [], "recordTypeMapping": [], "showDetails": false, "source": "Contact" }, { "destination": "Contact", "fieldMapping": [], "recordTypeMapping": [], "showDetails": false, "source": "" }, { "destination": "HealthcareProvider", "fieldMapping": [], "recordTypeMapping": [], "showDetails": false, "source": "" } ], "screenId": "m0K5f000000lvvdEAA", "sectionName": "Account Types - Provider" }, { "mappingData": [ { "destination": "Account", "fieldMapping": [], "recordTypeMapping": [ { "userGenerated": "true", "destination": "PersonAccount", "source": "" } ], "showDetails": false, "source": "" }, { "destination": "Account", "fieldMapping": [], "recordTypeMapping": [], "showDetails": false, "source": "Contact" } ], "screenId": "m0K5f000000lvvdEAA", "sectionName": "Account Types - Member" }, { "mappingData": [ { "destination": "CareProgram", "fieldMapping": [], "recordTypeMapping": [], "showDetails": false, "source": "" } ], "screenId": "m0K5f000000lvvsEAA", "sectionName": "Care Program - Care Program" } ]';

    private static final String RES_COMBINED = '[[{"Id":"m0m5f000000HGNGAA4"}],[{"Id":"m0d5f000000dGaVAAU","MasterLabel":"Account Types","DeveloperName":"Account_Types","'+Utilities.namespaceUnderscore+'Sort_Order__c":1,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaZAAU","MasterLabel":"Health Insurance","DeveloperName":"Health_Insurance","'+Utilities.namespaceUnderscore+'Sort_Order__c":2,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaaAAE","MasterLabel":"Provider Data","DeveloperName":"Provider","'+Utilities.namespaceUnderscore+'Sort_Order__c":3,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaXAAU","MasterLabel":"Care Program","DeveloperName":"Care_Program","'+Utilities.namespaceUnderscore+'Sort_Order__c":4,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaWAAU","MasterLabel":"Care Management","DeveloperName":"Care_Management","'+Utilities.namespaceUnderscore+'Sort_Order__c":5,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaYAAU","MasterLabel":"Code Sets","DeveloperName":"Code_Sets","'+Utilities.namespaceUnderscore+'Sort_Order__c":6,"'+Utilities.namespaceUnderscore+'Vertical__c":null}]]';

    private static final String RES_VERTICAL = '[[{"Id":"m0m5f000000HGNGAA4"}]]';
    private static final String RES_QUESTION_GROUP = '[[{"Id":"m0d5f000000dGaVAAU","MasterLabel":"Account Types","DeveloperName":"Account_Types","'+Utilities.namespaceUnderscore+'Sort_Order__c":1,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaZAAU","MasterLabel":"Health Insurance","DeveloperName":"Health_Insurance","'+Utilities.namespaceUnderscore+'Sort_Order__c":2,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaaAAE","MasterLabel":"Provider Data","DeveloperName":"Provider","'+Utilities.namespaceUnderscore+'Sort_Order__c":3,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaXAAU","MasterLabel":"Care Program","DeveloperName":"Care_Program","'+Utilities.namespaceUnderscore+'Sort_Order__c":4,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaWAAU","MasterLabel":"Care Management","DeveloperName":"Care_Management","'+Utilities.namespaceUnderscore+'Sort_Order__c":5,"'+Utilities.namespaceUnderscore+'Vertical__c":null},{"Id":"m0d5f000000dGaYAAU","MasterLabel":"Code Sets","DeveloperName":"Code_Sets","'+Utilities.namespaceUnderscore+'Sort_Order__c":6,"'+Utilities.namespaceUnderscore+'Vertical__c":null}]]';

    private static final String RES_GROUP2 = '[[{"Id":"m0d5f000000dGaWAAU","MasterLabel":"Care Management"}]]';
    private static final String RES_QUESTION = '[[{"Id":"m0e5f000000l8kZAAQ","MasterLabel":"HC Care Management","DeveloperName":"HC_Care_Management","'+Utilities.namespaceUnderscore+'Answer_Field_API_Name__c":"Tracks_Care_Management__c","'+Utilities.namespaceUnderscore+'Question_Group__c":"m0d5f000000dGaWAAU","'+Utilities.namespaceUnderscore+'Summary_Label_Name__c":"Question6Help","'+Utilities.namespaceUnderscore+'Question_Label_Name__c":"Question6"}]]';
    private static final String RES_ANSWER = '[[{"Id":"m0a5f000000hPWrAAM","DeveloperName":"Q6_Care_Plan_Problem","'+Utilities.namespaceUnderscore+'Help_Text_Label__c":"AnswerCarePlanProblemHelp","'+Utilities.namespaceUnderscore+'Mapped_Objects__c":"CarePlanProblem_c","'+Utilities.namespaceUnderscore+'Question_Label__c":"AnswerCarePlanProblem","'+Utilities.namespaceUnderscore+'Question__c":"m0e5f000000l8kZAAQ","'+Utilities.namespaceUnderscore+'Required_Vertical__c":null,"'+Utilities.namespaceUnderscore+'Index__c":1,"'+Utilities.namespaceUnderscore+'Follow_Up_To__c":"Q6_Care_Plans","'+Utilities.namespaceUnderscore+'Verbose_Help_Text_Label__c":"AnswerCarePlanProblemHelpV","'+Utilities.namespaceUnderscore+'Bottom_Help_Text_Label__c":null},{"Id":"m0a5f000000hPWtAAM","DeveloperName":"Q6_Care_Plans","'+Utilities.namespaceUnderscore+'Help_Text_Label__c":"AnswerCarePlanHelp","'+Utilities.namespaceUnderscore+'Mapped_Objects__c":"Case","'+Utilities.namespaceUnderscore+'Question_Label__c":"AnswerCarePlan","'+Utilities.namespaceUnderscore+'Question__c":"m0e5f000000l8kZAAQ","'+Utilities.namespaceUnderscore+'Required_Vertical__c":null,"'+Utilities.namespaceUnderscore+'Index__c":1,"'+Utilities.namespaceUnderscore+'Follow_Up_To__c":null,"'+Utilities.namespaceUnderscore+'Verbose_Help_Text_Label__c":"AnswerCarePlanHelpV","'+Utilities.namespaceUnderscore+'Bottom_Help_Text_Label__c":null},{"Id":"m0a5f000000hPWqAAM","DeveloperName":"Q6_Care_Plan_Goal","'+Utilities.namespaceUnderscore+'Help_Text_Label__c":"AnswerCarePlanGoalHelp","'+Utilities.namespaceUnderscore+'Mapped_Objects__c":"CarePlanGoal_c","'+Utilities.namespaceUnderscore+'Question_Label__c":"AnswerCarePlanGoal","'+Utilities.namespaceUnderscore+'Question__c":"m0e5f000000l8kZAAQ","'+Utilities.namespaceUnderscore+'Required_Vertical__c":null,"'+Utilities.namespaceUnderscore+'Index__c":2,"'+Utilities.namespaceUnderscore+'Follow_Up_To__c":"Q6_Care_Plans","'+Utilities.namespaceUnderscore+'Verbose_Help_Text_Label__c":"AnswerCarePlanGoalHelpV","'+Utilities.namespaceUnderscore+'Bottom_Help_Text_Label__c":null},{"Id":"m0a5f000000hPWuAAM","DeveloperName":"Q6_Life_Event","'+Utilities.namespaceUnderscore+'Help_Text_Label__c":"AnswerLifeEventHelp","'+Utilities.namespaceUnderscore+'Mapped_Objects__c":"PersonLifeEvent","'+Utilities.namespaceUnderscore+'Question_Label__c":"AnswerLifeEvent","'+Utilities.namespaceUnderscore+'Question__c":"m0e5f000000l8kZAAQ","'+Utilities.namespaceUnderscore+'Required_Vertical__c":null,"'+Utilities.namespaceUnderscore+'Index__c":2,"'+Utilities.namespaceUnderscore+'Follow_Up_To__c":null,"'+Utilities.namespaceUnderscore+'Verbose_Help_Text_Label__c":"AnswerLifeEventHelpV","'+Utilities.namespaceUnderscore+'Bottom_Help_Text_Label__c":null},{"Id":"m0a5f000000hPWsAAM","DeveloperName":"Q6_Care_Plan_Template","'+Utilities.namespaceUnderscore+'Help_Text_Label__c":"AnswerCarePlanTemplateHelp","'+Utilities.namespaceUnderscore+'Mapped_Objects__c":"CarePlanTemplate_c;CarePlanTemplateProblem;CarePlanTemplateGoal_c;CarePlanTemplateTask_c","'+Utilities.namespaceUnderscore+'Question_Label__c":"AnswerCarePlanTemplate","'+Utilities.namespaceUnderscore+'Question__c":"m0e5f000000l8kZAAQ","'+Utilities.namespaceUnderscore+'Required_Vertical__c":null,"'+Utilities.namespaceUnderscore+'Index__c":3,"'+Utilities.namespaceUnderscore+'Follow_Up_To__c":"Q6_Care_Plans","'+Utilities.namespaceUnderscore+'Verbose_Help_Text_Label__c":"AnswerCarePlanTemplateHelpV","'+Utilities.namespaceUnderscore+'Bottom_Help_Text_Label__c":null}]]';

    @TestSetup
    static void makeData(){
        Assessment__c setupAssessment = new Assessment__c(Selected_Products__c = 'AC Dealers');
        insert setupAssessment;
    }

    @IsTest
    static void getMenuItems(){
        Test.setMock(HttpCalloutMock.class, MockCalloutDefinitions.createMockWithResponseList(new List<String>{ RES_COMBINED }));
        Assessment__c assessment = [Select Id From Assessment__c Limit 1];
        
        Test.startTest();
        List<SFDC_Industry_Assessment_Question_Group__mdt> groups = HealthCloudMenuController.getMenuItems(assessment.Id);
        Test.stopTest();

        System.assert(groups.size()>0);
    }

    @IsTest
    static void getSectionByGroupId(){

        if(String.isBlank(Utilities.namespaceUnderscore)){
            Test.setMock(HttpCalloutMock.class, MockCalloutDefinitions.createMockWithResponseList(new List<String>{ RES_GROUP2, RES_COMBINED, RES_ANSWER, EXTERNAL_STRINGS, MockCalloutDefinitions.RES_MENU_OBJ }));
        }else{
            Test.setMock(HttpCalloutMock.class, MockCalloutDefinitions.createMockWithResponseList(new List<String>{ RES_GROUP2, RES_COMBINED, RES_ANSWER, EXTERNAL_STRINGS, MockCalloutDefinitions.RES_MENU_OBJ }));
        }
        
        //List<SFDC_Industry_Assessment_Question_Group__mdt> groups = [Select Id, MasterLabel FROM SFDC_Industry_Assessment_Question_Group__mdt LIMIT 1];
        Assessment__c assessment = [Select Id From Assessment__c Limit 1];
        
        Test.startTest();
        HealthCloudMenuController.SectionData sectionData = HealthCloudMenuController.getSectionByGroupId(''+assessment.Id, ''+'m0d5f000000dGaWAAU', ''+0);

        List<Object> listOfLists = (List<Object>) JSON.deserializeUntyped(RES_ANSWER);

        List<List<Object>> returnList = new List<List<Object>>();
        for (Object topList : listOfLists) {
            returnList.add((List<Object>) topList);
        }
        List<SFDC_Industry_Assessment_Answer__mdt> answers = (List<SFDC_Industry_Assessment_Answer__mdt>) JSON.deserialize(JSON.serialize(returnList[0]), List<SFDC_Industry_Assessment_Answer__mdt>.class);
        HealthCloudMenuController.MultiSelectQuestion multi = new HealthCloudMenuController.MultiSelectQuestion(answers, 'MappingDocTitle', 'MappingDocTitle');
        Test.stopTest();

        System.assert(sectionData!=null);
    }

    @IsTest
    static void saveMapping(){
        Test.setMock(HttpCalloutMock.class, new MockResponse(ExternalUtilities.HTTP_RESPONSE_CODE_SUCCESS, EXTERNAL_STRINGS));
        List<SFDC_Industry_Assessment_Question_Group__mdt> groups = [Select Id, MasterLabel FROM SFDC_Industry_Assessment_Question_Group__mdt LIMIT 1];
        Assessment__c assessment = [Select Id From Assessment__c Limit 1];
        
        Test.startTest();
        HealthCloudMenuController.saveMapping(+assessment.Id, NEW_MAPPING, groups[0].Id, '1');
        HealthCloudMenuController.saveMapping(+assessment.Id, NEW_MAPPING, groups[0].Id, '1');
        Test.stopTest();

        String mappingJSON = MappingService.getMappingJSON(assessment.Id);
        System.assert(!String.isBlank(mappingJSON));
    }
}
