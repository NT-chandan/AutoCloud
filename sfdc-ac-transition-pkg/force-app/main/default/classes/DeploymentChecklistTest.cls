/*
 * Copyright (c) 2023, Salesforce, Inc.
 * All rights reserved.
 * SPDX-License-Identifier: Apache 2.0 Clause
 * For full license text, see the LICENSE file in the repo root or http://www.apache.org/licenses/
 */
@isTest
private class DeploymentChecklistTest {
    static final String MAPPING_JSON_COMPLETE = '{"recommended":[{"mappingData":[{"destination":"Asset","destinationObjectMetaName":"Asset","fieldMapping":[{"source":"AccountId","destination":"AccountId","userGenerated":"true","currentMeta":{"childRelationshipName":"Account","connectedObject":"(Account)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"Name","destination":"Name","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"string","decimalPlaces":"0","length":"255","referenceType":"Lookup Relationship","required":true,"unique":false}},{"source":"AssetProvidedById","destination":"AssetProvidedById","userGenerated":"true","currentMeta":{"childRelationshipName":"AssetProvidedBy","connectedObject":"(Account)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"AssetServicedById","destination":"AssetServicedById","userGenerated":"true","currentMeta":{"childRelationshipName":"AssetServicedBy","connectedObject":"(Account)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"IsCompetitorProduct","destination":"IsCompetitorProduct","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"boolean","decimalPlaces":"0","length":"0","referenceType":"Lookup Relationship","required":true,"unique":false}},{"source":"ContactId","destination":"ContactId","userGenerated":"true","currentMeta":{"childRelationshipName":"Contact","connectedObject":"(Contact)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"CreatedById","destination":"CreatedById","userGenerated":"true","currentMeta":{"childRelationshipName":"CreatedBy","connectedObject":"(User)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":true,"unique":false}},{"source":"CreatedDate","destination":"CreatedDate","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"datetime","decimalPlaces":"0","length":"0","referenceType":"Lookup Relationship","required":true,"unique":false}},{"source":"Description","destination":"Description","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"textarea","decimalPlaces":"0","length":"32000","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"InstallDate","destination":"InstallDate","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"date","decimalPlaces":"0","length":"0","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"IsInternal","destination":"IsInternal","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"boolean","decimalPlaces":"0","length":"0","referenceType":"Lookup Relationship","required":true,"unique":false}},{"source":"LastModifiedById","destination":"LastModifiedById","userGenerated":"true","currentMeta":{"childRelationshipName":"LastModifiedBy","connectedObject":"(User)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":true,"unique":false}},{"source":"LastModifiedDate","destination":"LastModifiedDate","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"datetime","decimalPlaces":"0","length":"0","referenceType":"Lookup Relationship","required":true,"unique":false}},{"source":"OwnerId","destination":"OwnerId","userGenerated":"true","currentMeta":{"childRelationshipName":"Owner","connectedObject":"(User)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":true,"unique":false}},{"source":"ParentId","destination":"ParentId","userGenerated":"true","currentMeta":{"childRelationshipName":"Parent","connectedObject":"(Asset)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"Price","destination":"Price","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"currency","decimalPlaces":"2","length":"0","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"ProductCode","destination":"ProductCode","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"string","decimalPlaces":"0","length":"255","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"Product2Id","destination":"Product2Id","userGenerated":"true","currentMeta":{"childRelationshipName":"Product2","connectedObject":"(Product2)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"StockKeepingUnit","destination":"StockKeepingUnit","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"string","decimalPlaces":"0","length":"180","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"PurchaseDate","destination":"PurchaseDate","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"date","decimalPlaces":"0","length":"0","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"Quantity","destination":"Quantity","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"double","decimalPlaces":"2","length":"0","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"RootAssetId","destination":"RootAssetId","userGenerated":"true","currentMeta":{"childRelationshipName":"RootAsset","connectedObject":"(Asset)","dataType":"reference","decimalPlaces":"0","length":"18","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"SerialNumber","destination":"SerialNumber","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"string","decimalPlaces":"0","length":"80","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"Status","destination":"Status","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"picklist","decimalPlaces":"0","length":"255","referenceType":"Lookup Relationship","required":false,"unique":false}},{"source":"UsageEndDate","destination":"UsageEndDate","userGenerated":"true","currentMeta":{"connectedObject":"()","dataType":"date","decimalPlaces":"0","length":"0","referenceType":"Lookup Relationship","required":false,"unique":false}}],"recordTypeMapping":[{"source":"Master","destination":"Master","userGenerated":"true"}],"showDetails":true,"source":"Asset","rtCountString":"1 of 1 Record Type(s) Mapped","fieldCountString":"25 of 49 Field(s) Mapped","childCountString":"0 of 0 Child Relationship(s) Mapped"}],"screenId":"m0D1Q0000000jGcUAI","sectionName":"Financial Services Information - Asset"}],"additional":[]}';
    static final String ANALYSIS_JSON_COMPLETE = '{"migrationAnalysis":[{"toComponentName":"FinServ__FinancialAccount__c","fromComponentType":"CustomObject","fromComponentId":"01I4x000000VYCnEAO","fromComponentName":"Assessment","children":[{"fromComponentType":"CompactLayout","fromComponentName":"Compact Layout (1)","children":[{"fromComponentType":"CompactLayout","fromComponentId":"0AH4x000001GwftGAC","fromComponentName":"Test_Compact_INGORE","children":[]}]},{"fromComponentType":"FieldSet","fromComponentName":"Field Set (1)","children":[{"fromComponentType":"FieldSet","fromComponentId":"0IX4x0000004YxbGAE","fromComponentName":"Test_IGNORE","children":[{"fromComponentId":"0IX4x0000004YxbGAF","children":[],"fromComponentType":"FieldSet","fromComponentName":"Test_IGNORE2"},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000DuR3VEAV","fromComponentName":"Bulk_Scan_Complete","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000KlmzQEAR","fromComponentName":"Financial_Accounts_Leveraged","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foK3EAI","fromComponentName":"Is_B2C","children":[]}]}]},{"fromComponentType":"FlexiPage","fromComponentName":"Lightning Page (1)","children":[{"fromComponentType":"FlexiPage","fromComponentId":"0M04x000002KVefCAG","fromComponentName":"Assessment_Record_Page","children":[{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmULAA1","fromComponentName":"UIAssessmentPageTabChecklist","children":[]},{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmUQAA1","fromComponentName":"UIAssessmentPageTabDeploy","children":[]},{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmUGAA1","fromComponentName":"UIAssessmentPageTabInstall","children":[]},{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmUBAA1","fromComponentName":"UIAssessmentPageTabReport","children":[]},{"fromComponentType":"CustomLabel","fromComponentId":"1014x00000QDmUVAA1","fromComponentName":"UIAssessmentPageTabRollout","children":[]},{"fromComponentType":"LightningComponentBundle","fromComponentId":"0Rb4x0000001pctCAA","fromComponentName":"assessmentResults","children":[]},{"fromComponentType":"LightningComponentBundle","fromComponentId":"0Rb4x0000003x9OCAQ","fromComponentName":"deploymentChecklist","children":[]},{"fromComponentType":"LightningComponentBundle","fromComponentId":"0Rb4x0000003xDkCAI","fromComponentName":"packageScreen","children":[]}]}]},{"fromComponentType":"RecordType","fromComponentName":"Record Type (1)","children":[{"toComponentName":"Brokerage","fromComponentType":"RecordType","fromComponentName":"Master","children":[]}]},{"fromComponentType":"ReportType","fromComponentName":"Report Type (1)","children":[{"fromComponentType":"ReportType","fromComponentId":"0704x000000Ls70AAC","fromComponentName":"Test_Report_Type","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foKNEAY","fromComponentName":"AnalysisDataJSON","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Q659AEAR","fromComponentName":"Apex_Sharing_Scan_Complete","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000DuR3VEAV","fromComponentName":"Bulk_Scan_Complete","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000KkwJKEAZ","fromComponentName":"Current_Question_Id","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000KkwJPEAZ","fromComponentName":"Current_Question_Number","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Du46tEAB","fromComponentName":"Customer_Representation","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Dx1j8EAB","fromComponentName":"External_Data_In_Salesforce","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000KlmzQEAR","fromComponentName":"Financial_Accounts_Leveraged","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Q65CxEAJ","fromComponentName":"HasMappingData","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000Q5rviEAB","fromComponentName":"Has_Apex_Sharing","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foK8EAI","fromComponentName":"Has_Relationship_Groups","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000DuM0jEAF","fromComponentName":"Has_Rollups","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foK3EAI","fromComponentName":"Is_B2C","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foKIEAY","fromComponentName":"MappingDataJSON","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000DuM0ZEAV","fromComponentName":"Relationship_Groupings","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foJzEAI","fromComponentName":"Selected_Products","children":[]},{"toComponentName":"FinServ__Status__c","fromComponentType":"CustomField","fromComponentId":"00N4x000007foJFEAY","fromComponentName":"Status","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x000007foKDEAY","fromComponentName":"Upgrade_Recommendation","children":[]}]}]}]},{"toComponentName":"Account","fromComponentType":"StandardEntity","fromComponentId":"Contact","fromComponentName":"Contact","children":[{"fromComponentType":"FieldSet","fromComponentName":"Field Set (1)","children":[{"fromComponentType":"FieldSet","fromComponentId":"0IX4x0000004YxgGAE","fromComponentName":"Contact_FieldSet_Test","children":[]}]},{"fromComponentType":"Layout","fromComponentName":"Page Layout (4)","children":[{"fromComponentType":"Layout","fromComponentId":"00h4x000003wltyAAA","fromComponentName":"Contact (Marketing) Layout","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcPEAV","fromComponentName":"Languages","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcQEAV","fromComponentName":"Level","children":[]}]},{"fromComponentType":"Layout","fromComponentId":"00h4x000003wltzAAA","fromComponentName":"Contact (Sales) Layout","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcPEAV","fromComponentName":"Languages","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcQEAV","fromComponentName":"Level","children":[]}]},{"fromComponentType":"Layout","fromComponentId":"00h4x000003wlu0AAA","fromComponentName":"Contact (Support) Layout","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcPEAV","fromComponentName":"Languages","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcQEAV","fromComponentName":"Level","children":[]}]},{"fromComponentType":"Layout","fromComponentId":"00h4x000003wlu1AAA","fromComponentName":"Contact Layout","children":[{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcPEAV","fromComponentName":"Languages","children":[]},{"fromComponentType":"CustomField","fromComponentId":"00N4x00000BkCcQEAV","fromComponentName":"Level","children":[]}]}]},{"uuid":"1faa6ab8-3743-cf7b-0779-99f70fa3331c","toComponentUrl":null,"toComponentName":null,"reasonText":"Email Template can be automatically migrated. Use the Generate Changes tab to select and generate changes for deployment.","fromComponentUrl":"https://fsc-upgrade-development-dev-ed.my.salesforce.com/lightning/setup/CommunicationTemplatesEmail/home","fromComponentType":"EmailTemplate","fromComponentName":"Email Template (1)","fromComponentInternalSharing":null,"fromComponentId":null,"fromComponentExternalSharing":null,"children":[{"uuid":"102cb32a-f55e-8d14-6101-2ca9261d9265","toComponentUrl":null,"toComponentName":null,"reasonText":null,"fromComponentUrl":"https://fsc-upgrade-development-dev-ed.my.salesforce.com/lightning/setup/CommunicationTemplatesEmail/page?address=%2F00X4x000000pnSrEAI","fromComponentType":"EmailTemplate","fromComponentName":"Awesome_Emails","fromComponentInternalSharing":null,"fromComponentId":"00X4x000000pnSrEAI","fromComponentExternalSharing":null,"children":[]}]},{"fromComponentType":"ListView","fromComponentName":"List View (6)","children":[{"fromComponentType":"ListView","fromComponentId":"00B4x000006hcwgEAA","fromComponentName":"All Contacts","children":[]},{"fromComponentType":"ListView","fromComponentId":"00B4x000006hcw9EAA","fromComponentName":"Birthdays This Month","children":[]},{"fromComponentType":"ListView","fromComponentId":"00B4x000006hcw9EAZ","fromComponentName":"Recently Viewed Contacts","children":[]}]},{"fromComponentType":"RecordType","fromComponentName":"Record Type (1)","children":[{"toComponentName":"PersonAccount","fromComponentType":"RecordType","fromComponentName":"Master","children":[]}]}]}],"accessInfoResults":[{"uuid":"4c0a40a1-26c9-7efb-3eba-81bfa6391f88","toComponentName":null,"reasonText":"0","fromComponentType":"Profile","fromComponentId":"00e4x000001ngr5AAA","fromComponentName":"Custom: Marketing Profile","children":[]},{"uuid":"4c0a40a1-26c9-7efb-3eba-81bfa6391f89","toComponentName":null,"reasonText":"10","fromComponentType":"PermissionSet","fromComponentId":"00e4x000001ngrFAKE","fromComponentName":"Awesome Permission Set","children":[]}]}';
    static final String ASSESSMENT_STATUS_REVIEW = 'Review';

    static testMethod void testGenerateDeploymentList_Success() {
        Assessment__c assessment = new Assessment__c(MappingDataJSON__c = MAPPING_JSON_COMPLETE);
        insert assessment;
        TransitionAnalysis.saveAnalysis(assessment.Id, (TransitionAnalysis)JSON.deserialize(ANALYSIS_JSON_COMPLETE, TransitionAnalysis.class));

        //set metadata responses and fake custom labels obtained by Tooling
        Test.setMock(HttpCalloutMock.class, MockCalloutDefinitions.createMockWithResponseList(new List<String>{ MockCalloutDefinitions.RES_SECTION_NAME_DESC, '{}' }));

        Test.startTest();
            DeploymentChecklist.SECTION_NAME_DESCRIPTION.put('CustomField', 'Custom Fields');
            List<DeploymentChecklist.DeploymentChecklistSection> deploymentList = DeploymentChecklist.generateDeploymentList(assessment.Id);
        Test.stopTest();

        System.assertNotEquals(null, deploymentList, 'List should be generated with DeploymentChecklistSection type');
    }

    static testMethod void testSaveDeploymentChecklist_Success() {
        Assessment__c assessment = new Assessment__c(MappingDataJSON__c = MAPPING_JSON_COMPLETE);
        insert assessment;

        DeploymentChecklist.SECTION_NAME_DESCRIPTION = new Map<String,String>{'CustomField' => 'Custom Fields'};
        List<DeploymentChecklist.DeploymentChecklistSection> deploymentList = DeploymentChecklist.generateDeploymentList(assessment.Id);

        Test.startTest();
            Id fileId = DeploymentChecklist.saveDeploymentChecklist(assessment.Id, JSON.serialize(deploymentList));
        Test.stopTest();

        System.assertNotEquals(null, fileId, 'Expecting fileId to be generated after file save');
    }

    static testMethod void testGenerateDeploymentPackage_Success() {
        Assessment__c assessment = new Assessment__c(Status__c=ASSESSMENT_STATUS_REVIEW, MappingDataJSON__c = MAPPING_JSON_COMPLETE);
        insert assessment;

        DeploymentChecklist.SECTION_NAME_DESCRIPTION = new Map<String,String>{'CustomField' => 'Custom Fields'};
        List<DeploymentChecklist.DeploymentChecklistSection> deploymentList = DeploymentChecklist.generateDeploymentList(assessment.Id);
        Id fileId = DeploymentChecklist.saveDeploymentChecklist(assessment.Id, JSON.serialize(deploymentList));

        Test.setMock(HttpCalloutMock.class, new MockResponse(ExternalUtilities.HTTP_RESPONSE_CODE_PROCESSING, 'ok'));
        Test.startTest();
            Boolean isSuccess = DeploymentChecklist.generateDeploymentPackage(assessment.Id, fileId);
        Test.stopTest();

        System.assertEquals(true, isSuccess, 'Expecting true after API callout response');
    }

    static testMethod void testGenerateDeploymentPackage_CalloutFail() {
        Assessment__c assessment = new Assessment__c(MappingDataJSON__c = MAPPING_JSON_COMPLETE);
        insert assessment;

        DeploymentChecklist.SECTION_NAME_DESCRIPTION = new Map<String,String>{'CustomField' => 'Custom Fields'};
        List<DeploymentChecklist.DeploymentChecklistSection> deploymentList = DeploymentChecklist.generateDeploymentList(assessment.Id);
        Id fileId = DeploymentChecklist.saveDeploymentChecklist(assessment.Id, JSON.serialize(deploymentList));

        Test.setMock(HttpCalloutMock.class, new MockResponse(ExternalUtilities.HTTP_RESPONSE_CODE_FAILURE, 'fail'));
        Test.startTest();
            Boolean isSuccess = DeploymentChecklist.generateDeploymentPackage(assessment.Id, fileId);
        Test.stopTest();

        System.assertEquals(false, isSuccess, 'Expecting false after failed API callout response');
    }
}